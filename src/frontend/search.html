<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags always come first -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="node_modules/bootstrap/dist/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="css/styles.css" />

    <title>Ristorante Con Fusion</title>
  </head>

  <body>
    <header class="jumbotron" align="center">
      <div class="container">
        <div class="row row-header">
          <div class="col-12 col-md-6">
            <h1>Movie Search</h1>
          </div>
          <div class="col col-md"></div>
        </div>
      </div>
    </header>

    <div class="container" align="center">
      <div class="row-content">
      <div class="row align-items-center  ">
        <div class="col-12 col-md-1 text-right">Field:</div>
        <div class="col-12 col-md text-left " id="dropDown"></div>
      </div>
      <br>
      <div id='textQuery' class="row align-items-center text-right">
        <div class="col-12 col-md-1 text-right">Query:</div>
        <div class="col-12 col-md text-left"><input type="text" id='textQueryField'></div>
      </div>

      <div id='numQuery' class="row align-items-center">
        <div class="col-12 col-md-1 text-right" id="numQueryTitle">Budget</div>
        <div class="col-12 col-md-1 text-left"><select id="ineqSelector">
            <option value="0">=</option>
            <option value="1">></option>
            <option value="2=">>=</option>
            <option value="3">&lt</option>
            <option value="4=">&lt=</option>

        </select></div>
        <div><input type="text" id='numQueryField'></div>
      </div>
      <br>
      <div class="row align-items-center">
          <div class="col-12 col-md-1 "></div>
        <div class="col col-md text-left" >
          <button type="button" class="btn btn-primary " onCLick=go()>Search</button>
        </div>
      </div>
    </div>
    <br>
      <div class="row align-items-center"></div>
      <table class="table ">
          <thead>
            <tr id='headerRow'>

            </tr>
          </thead>
          <tbody id="bodyBoy">

          </tbody>
        </table>
        </div>
    </div>

    <!-- jQuery first, then Popper.js, then Bootstrap JS. -->
    <script src="node_modules/jquery/dist/jquery.slim.min.js"></script>
    <script src="node_modules/popper.js/dist/umd/popper.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script>

      //Data from the query
      var data;

      //current search field
      var searchField = 'id';

      //Initial setting to hide the query options
      $('#textQuery').show()
      $('#numQuery').hide()

      //Global flag for type of query 
      var isNumeric = false;

      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          // Typical action to be performed when the document is ready:
          data = JSON.parse(xhttp.responseText);

          console.log(Object.keys(data));
        Object.keys(data).forEach(item=>{

          $("#headerRow").append('<th>'+item+'</th>')

        })

          for (var val in Object.keys(data)) {
            $("<option />", {
              text: Object.keys(data)[val],
              value: data[Object.keys(data)[val]]
            }).appendTo(s);
          }

          s.appendTo("#dropDown");

          $("#fieldSelector").change(function () {
            searchField=this.options[this.selectedIndex].text
            if(this.value=='numeric'){
              $('#textQuery').hide()
              $('#numQuery').show()
              document.getElementById("numQueryTitle").innerText = searchField
              isNumeric = true;

            }
            else{
              $('#textQuery').show()
              $('#numQuery').hide()
              isNumeric = false;
            }

          console.log(searchField)
          console.log(isNumeric)
          });
        }
      };
      xhttp.open("GET", "http://localhost:5000/headers", true);
      xhttp.send();
      var s = $("<select id='fieldSelector'/>");


 


      function go(){    
        

        $('#bodyBoy').children().remove()

        let urlString='http://localhost:5000/'

        if(isNumeric){
          urlString+='searchNumeric?search_field='+searchField+'&search_inequality='+document.getElementById("ineqSelector").value+'&search_query='+document.getElementById("numQueryField").value
        }
        else{
          urlString+='searchText?search_field='+searchField+'&search_query='+document.getElementById("textQueryField").value
        }
        
        console.log(urlString)


        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          // Typical action to be performed when the document is ready:
          let records = JSON.parse(xhttp.responseText);
          console.log(records)
          records.forEach(element => {
          
          let dataStr = '<tr>'
              Object.keys(data).forEach(item=>{

            dataStr+='<td>'+element[item]+'</td>'


          })
          dataStr+='</tr>'
           $("#bodyBoy").append(dataStr);

          });

        }
      };
      xhttp.open("GET",urlString, true);
      xhttp.send();
      }





    </script>
  </body>
</html>
